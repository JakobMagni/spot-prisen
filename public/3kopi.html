<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <script src="scripts/d3.js"></script>
  <link rel="stylesheet" href="style.css">
  <title>Postgres node.js template med d3.js</title>
</head>

<body>

  <div class="myDiv">
    <h2>This is a heading in a div element</h2>
    <p>This is some text in a div element.</p>
  </div>

  <div id="diagram1"></div>

  <script>
    // Denne query kører op imod API'en som findes i 'main.js'.

    d3.json("/api/elafgift", {
      method: "POST",
    }).then(function (response) {
      const data_elafgift = response.data; // Hent data ud af response
      console.log("elafgift", data_elafgift)
    })

      // Ugentlig gennemsnits max- og minpris
      d3.json("/api/avg_weekly", {
        method: "POST",
      }).then(function (response) {
        const data_avg_weekly = response.data; // Hent data ud af response
        console.log("Ugentlig gennemsnitsdata", data_avg_weekly)
      })


        // Query for tarif-data
        d3.json("/api/tarif_sum", {
          method: "POST",
        }).then(function (response) {
          const data_tarif = response.data; // Hent data ud af response
          console.log("tarif", data_tarif)

        })




          //Get specified amount of data from specified dataset
          fetch('https://api.energidataservice.dk/dataset/Elspotprices?columns=SpotPriceDKK,HourDK,PriceArea&filter={%22PriceArea%22:[%22DK1%22]}&limit=48')
            .then(response => response.json())
            .then(data => {
             // alert(`retrieved ${data.limit} of ${data.total}`);
              console.group("Data retrieved:");
              data.records.forEach(record => console.log(record));
              console.groupEnd()

              const data_avg_hour = data.records

          console.log("Timepris 24 timer", data_avg_hour)
          console.log("Cons log 1", data_avg_hour)
              
            


          //Definere højde, bredde og svg elements attributter 
          var width = 900;
          var height = 450;
          var bottomPadding = 20;
          var barPadding = 50; // Padding imellem bars
          var svg = d3.select("#diagram1").append("svg").attr("width", width).attr("height", height);


          // Skalering 
          var xScale = d3.scaleBand().domain(d3.range(data_avg_hour.length )).range([30, width]).paddingInner(20).padding(0.1)
          var yScale = d3.scaleLinear().domain([0, d3.max(data_avg_hour, (d) => d.SpotPriceDKK * 1.25)]).range([height - bottomPadding, 90]);

          
          var color = d3.scaleLinear() //farve skalering
            .domain([0, d3.max(data_avg_hour)])
            .range(['#9ad97f', '#d97642']);

          // Lave og placere akser (Y aksen)
            


          // Farver 
          var color = d3.scaleLinear()
            .domain([0, d3.max(data_avg_hour, (d) => d.SpotPriceDKK)])
            .range(["#9ad97f", "#d97642"]);


          
            





           var Tooltip = d3.selectAll("body") //Tooltip 
            .data(data_avg_hour)
            .enter()
            .append("body")
            .text(function (d) {
            return +(Math.round([d.SpotPriceDKK]))
            })
            .append()
            .style("opacity", 0 )
            .attr("class", "Tooltip")
            .style("position", "absolute")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px")
            



             // Tre funktioner der ændrer tooltippet når man hover og mover den hen over grafen 
           
             var mouseover = function(d) {Tooltip
            .style("opacity", 1)
          d3.select(this)
            .style("stroke", "black")
            .style("opacity", 1)
            }

        var mousemove = function(d) {Tooltip
        .text(function (d) {
            return +(Math.round(d.SpotPriceDKK))
          })
        .style("top", (event.pageY) + "px")
        .style("left",(event.pageX)+"px")
    
          }
          var mouseleave = function(d) {Tooltip
          .style("opacity", 0)
          d3.select(this)
          .style("stroke", "none")
          .style("opacity", 0.8)
         
          }
  
    


          // Definere svg elementet som en variabel = bars og koble data og function for barer på 
          var bars = svg.selectAll("#diagram1")
            .data(data_avg_hour)
            .enter()
            .append("path") 
            .attr("x", function(d, i) {
			   		return xScale(i);
      })
			   .attr("y", function(d) {
			   	return height - yScale(d)})
          //tooltip og mouseover  i barsne
           .style("stroke-width", 4)
           .style("stroke", "none")
           .style("opacity", 0.8)
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)
            .attr("fill", function (d) { return color(d.SpotPriceDKK) })
            //.transition()
           // .delay(function (d, i) 
          //{
          //   return i / data_avg_hour.length * 8000
          // })
      
           // .duration(100)
            .attr("d", function (d, i) {
              return bar(xScale(i), yScale(0), xScale.bandwidth(), yScale(0) - yScale(data_avg_hour[i].SpotPriceDKK * 1.25), 10)});
            
           //.attr("fill", function(d) {return "rgb(0, 0, " + Math.round(d * 20) + ")";})
                //.on("mouseover", function(d) { d3.select(this) // mouseover funktion
                      //.attr("fill", "brown");})
			                //.on("mouseout", function(d) { d3.select(this)
				   		        //.transition()
				   		       // .duration(50)
						         //.attr("fill", "rgb(0, 0, " + (d * 20) + ")")
                     //.attr("fill", function(d) {return color(d.SpotPriceDKK)})
                     // })

      
           // .attr("d", function (d) {
           //   return bar(xScale(d.HourDK), yScale(0), xScale.bandwidth(), yScale(0) - yScale(0), 10)
           // })
           //.style("fill", function(d) { return color(d.SpotPriceDKK)} )
          







          // Funktion som lager barer med afrundede kanter 
          function bar(x, y, w, h, r, f) {
            // Flag for sweep:
            if (f == undefined) f = 1;

            // x coordinates of top of arcs
            var x0 = x + r;
            var x1 = x + w - r;
            // y coordinates of bottom of arcs
            var y0 = y - h + r;
            // just for convenience (slightly different than above):
            var l = "L", a = "A";

            var parts = ["M", x, y, l, x, y0, a, r, r, 0, 0, f, x0, y - h, l, x1, y - h, a, r, r, 0, 0, f, x + w, y0, l, x + w, y, "Z"];
            return parts.join(" ");
          }
          //Create labels
          svg.selectAll("text.label") // Alt tekst med class 'label'
            .data(data_avg_hour)
            .enter()
            .append("text")
            .text(function (d) {
              return +(Math.round(d.SpotPriceDKK * 1.25 + "e+2") + "e-2");
            })
            .attr("x", function (d, i) {
              return i * (width / data_avg_hour.length - 2.8) + 44;
            })
            .attr("y", function (d) {
              return height - (d.SpotPriceDKK * 185) - 43;
            })
            .attr("class", "label") // Husk class på nye labels
            .attr("font-family", "sans-serif")
            .attr("font-weight", 800)
            .attr("text-anchor", "middle")
            .attr("font-size", "11px")
            .attr("fill", data_avg_hour => color(data_avg_hour.SpotPriceDKK * 1.25))
            

          const xAxis = d3.axisBottom()
          .scale(d3.scaleLinear()
          .domain([0, data_avg_hour.length]).range([1, width ]))
           .ticks(12)
          svg.append("g")
            .attr("transform", "translate(30," + (height - 20) + ")")
            // d3.js laver sin magi
            .call(xAxis);



          const yAxis = d3.axisLeft()
            .scale(yScale).ticks();
          svg.append("g")
            .attr("transform", "translate(30)")
            .attr("y", function (d) {
              console.log(data_avg_hour, yScale(data_avg_hour));
              return yScale(data_avg_hour);})
            .call(d3.axisLeft(yScale));
            
          
          
          console.log("Loading complete")
          // Lav din egen visualsering med data her!
               
            });
  </script>
</body>
</html>